
# ğŸ“œã€Šé€šç”¨ç›®éŒ„å“¨å…µæ§åˆ¶ä¸­å¿ƒï¼šå°ˆæ¡ˆé€šè¨Šå”å®šæ›¸ v3.3ï¼ˆé‡æ§‹ç‰ˆï¼‰ã€‹

**æ–‡ä»¶ IDï¼šLAPLACE-SENTRY-PROTOCOL-V3.3**
**ç‹€æ…‹ï¼šç”Ÿæ•ˆä¸­ï¼ˆ2025-11-22ï¼‰**
**å±¤ç´šï¼šç³»çµ±å¥‘ç´„ï¼ˆSystem Contractï¼‰**

> æ­¤æ–‡ä»¶ç‚ºæ•´å€‹ Laplace Sentry Control çš„ã€Œæœ€é«˜é€šä¿¡æ³•æ¡ˆã€ã€‚
> å®ƒè¦ç¯„æ‰€æœ‰æ¨¡çµ„ã€æ‰€æœ‰é€šè¨Šè·¯å¾‘ã€æ‰€æœ‰ç‹€æ…‹è®ŠåŒ–ï¼Œä¸¦å®šç¾©å‰ç«¯ã€å¾Œç«¯ã€å“¨å…µä¸‰è€…é–“çš„åˆæ³•äº’å‹•æ–¹å¼ã€‚
> æ‰€æœ‰å·¥ç¨‹æ±ºç­–å¿…é ˆéµå®ˆæœ¬å”å®šæ›¸ï¼Œé•åè€…è¦–ç‚º **éæ³•è¡Œç‚º**ã€‚

---

# ç›®éŒ„

1. **ç¸½ç¶±ï¼ˆGeneral Principlesï¼‰**
2. **æ¨¡çµ„æ¶æ§‹èˆ‡è²¬ä»»ç•Œç·šï¼ˆModule Boundariesï¼‰**
3. **C/S é€šä¿¡å¥‘ç´„ï¼ˆClientâ€“Server Contractï¼‰**
4. **å“¨å…µé€šä¿¡æ¨¡å‹ï¼ˆSentry Communication Modelï¼‰**
5. **è³‡æ–™æŒä¹…åŒ–èˆ‡ I/O å¥‘ç´„ï¼ˆI/O Gateway Contractï¼‰**
6. **éŒ¯èª¤ç¢¼è¦ç¯„ï¼ˆExit Code Specificationï¼‰**
7. **ç‹€æ…‹å› æœéˆï¼ˆState Causality Graphï¼‰**
8. **é™„éŒ„ï¼šæ­£å¼æŒ‡ä»¤åˆ—è¡¨ï¼ˆCanonical Command Listï¼‰**

---

# 1. ç¸½ç¶±ï¼ˆGeneral Principlesï¼‰

æœ¬å”å®šæ›¸æ¡ç”¨ä¸‰å¤§ä¸å¯é•ååŸå‰‡ï¼š

## **1.1 å–®ä¸€çœŸç†ä¾†æºï¼ˆSSoTï¼šSingle Source of Truthï¼‰**

æ‰€æœ‰ç‹€æ…‹ä¾†æº **æ‡‰ä¸”åªèƒ½** ç”±ä»¥ä¸‹ä¸‰è€…ä¹‹ä¸€ç”¢ç”Ÿï¼š

1. `projects.json`ï¼ˆå°ˆæ¡ˆè¨»å†Šè³‡è¨Šï¼‰
2. å“¨å…µé€²ç¨‹ï¼ˆruntime â†’ muted_pathsï¼‰
3. å¼•æ“ï¼ˆengineï¼‰ç”¢ç”Ÿçš„ç›®éŒ„æ¨¹

å‰ç«¯ä¸å¾—ä¿®æ”¹ä»»ä½•ç‹€æ…‹ï¼Œåªå…è¨±ï¼š

* ç™¼é€è«‹æ±‚
* é¡¯ç¤ºçµæœ
* å¼•å°äº¤äº’

---

## **1.2 åš´æ ¼é‚è¼¯é‚Šç•Œï¼ˆStrict Module Boundariesï¼‰**

æ¯å€‹æ¨¡çµ„å¿…é ˆè² è²¬**å–®ä¸€é ˜åŸŸ**ï¼š

| æ¨¡çµ„                 | è²¬ä»»                        |
| ------------------ | ------------------------- |
| `main.py`          | äººæ©Ÿä»‹é¢èˆ‡è«‹æ±‚ç™¼é€ï¼ˆClientï¼‰         |
| `daemon.py`        | çµ±ä¸€æ¥­å‹™é‚è¼¯ä¸­å¿ƒï¼ˆServerï¼‰          |
| `engine.py`        | ç›®éŒ„æ¨¹ç”Ÿæˆï¼ˆPure Functionï¼‰      |
| `path.py`          | è·¯å¾‘æ¸…æ´—ã€æ­£è¦åŒ–ã€I/O CLI å·¥å…·       |
| `io_gateway.py`    | æ‰€æœ‰è³‡æ–™å¯«å…¥çš„å”¯ä¸€å…¥å£ï¼ˆAtomic Writeï¼‰ |
| `sentry_worker.py` | å¯¦æ™‚æª”æ¡ˆäº‹ä»¶ â†’ æ™ºèƒ½éœé»˜             |

ä»»ä½•è·¨è·è²¬çš„è¡Œç‚º **å‡å±¬éæ³•**ã€‚

---

## **1.3 ç•°å¸¸é©…å‹•æ¶æ§‹ï¼ˆException-Driven Architectureï¼‰**

æ‰€æœ‰éŒ¯èª¤è¨Šè™Ÿå¿…é ˆï¼š

* **ç”±å¾Œç«¯æ‹‹å‡º**
* **ç”± exit code æ¨™ç¤º**
* **ç”± stderr è¼¸å‡º**
* **ç”±å‰ç«¯è™•ç†**

å‰ç«¯ä¸å¾—åéŒ¯ã€ä¸å‡†æ¨æ¸¬ã€ä¸å‡†ä¿®è£œå¾Œç«¯éŒ¯èª¤ã€‚

---

# 2. æ¨¡çµ„æ¶æ§‹èˆ‡è²¬ä»»ç•Œç·šï¼ˆModule Boundariesï¼‰

æ­¤ç« å®šç¾©**æ¨¡çµ„ä¸å¯é€¾è¶Šçš„é‚Šç•Œ**ã€‚

---

## 2.1 `main.py` â€” å®¢æˆ¶ç«¯ï¼ˆClientï¼‰

å”¯ä¸€è²¬ä»»ï¼š

* æ¥æ”¶ä½¿ç”¨è€…è¼¸å…¥
* é¡¯ç¤ºçµæœ
* é€å‘½ä»¤çµ¦ daemon

ä¸å¾—ï¼š

* ä¿®æ”¹å°ˆæ¡ˆè³‡æ–™
* åŸ·è¡Œ I/O
* å­˜å–å“¨å…µ
* ç”Ÿæˆç›®éŒ„æ¨¹

---

## 2.2 `daemon.py` â€” å®ˆè­·é€²ç¨‹ï¼ˆServerï¼‰

å”¯ä¸€åˆæ³•ä»»å‹™ï¼š

* è™•ç†æ‰€æœ‰ C/S æŒ‡ä»¤ï¼ˆRPC processorï¼‰
* ç®¡ç†å°ˆæ¡ˆç”Ÿå‘½é€±æœŸ
* æ§åˆ¶å“¨å…µé€²ç¨‹
* è§¸ç™¼å¼•æ“
* é€é I/O Gateway å®ŒæˆåŸå­å¯«å…¥

ä¸å¾—ï¼š

* æ“ä½œæª”æ¡ˆï¼ˆç›´æ¥ open çš†å±¬éæ³•ï¼‰
* ç›´æ¥ä¿®æ”¹ç›®éŒ„æ¨¹å…§å®¹ï¼ˆåªèƒ½å‘¼å« engineï¼‰
* è‡ªå·±ç”Ÿæˆ ignore patterns

---

## 2.3 `engine.py` â€” ç›®éŒ„æ¨¹ç”Ÿæˆå™¨ï¼ˆPure Functionï¼‰

åªèƒ½åšï¼š

* æƒææª”æ¡ˆç³»çµ±
* ç”Ÿæˆæ–‡å­—æ¨¹
* åˆä½µè¨»é‡‹

ä¸å¾—ï¼š

* è®€å¯« projects.json
* å‘¼å« daemon
* å‘¼å«å“¨å…µ
* å¯«å…¥æª”æ¡ˆ

engine æ˜¯ç´”å‡½å¼ï¼š
**åŒæ¨£è¼¸å…¥ï¼Œå¿…é ˆç”¢ç”ŸåŒæ¨£è¼¸å‡ºã€‚**

---

## 2.4 `sentry_worker.py` â€” å“¨å…µï¼ˆBackground Runtimeï¼‰

å”¯ä¸€åˆæ³•ä»»å‹™ï¼š

* æ¥æ”¶æª”æ¡ˆäº‹ä»¶ï¼ˆvia watchdogï¼‰
* é€é SmartThrottler åšæ™ºèƒ½éœé»˜
* å¯«å…¥ `/tmp/<uuid>.sentry_status`

ä¸å¾—ï¼š

* ç”Ÿæˆç›®éŒ„æ¨¹
* ä¿®æ”¹å°ˆæ¡ˆè³‡æ–™
* æ±ºå®š ignore patterns
* å‘¼å« daemonï¼ˆåªèƒ½é€éç‹€æ…‹æª” communicateï¼‰

---

## 2.5 `io_gateway.py` â€” I/O å–®ä¸€ä¾†æº

æ‰€æœ‰å¯«å…¥è¡Œç‚ºéƒ½å¿…é ˆé€éï¼š

```
io_gateway.safe_read_modify_write()
```

ç¢ºä¿ï¼š

* åŸå­å¯«å…¥
* è‡ªå‹•å‚™ä»½
* è‡ªå‹•ä¿®å¾©
* å¤šé€²ç¨‹å®‰å…¨

ä»»ä½•åœ°æ–¹å‡ºç¾ç›´æ¥ `open(path, 'w')` å‡å±¬é•æ³•ã€‚

---

# 3. C/S é€šä¿¡å¥‘ç´„ï¼ˆClientâ€“Server Contractï¼‰

æ­¤ç« å®šç¾©ï¼š

* æŒ‡ä»¤åˆ†é¡
* æŒ‡ä»¤èªæ³•
* æ³•å¾‹æ•ˆæœï¼ˆç‹€æ…‹å¦‚ä½•è®ŠåŒ–ï¼‰
* å›æ‡‰è¦ç¯„

---

## **3.1 æŒ‡ä»¤åˆ†é¡ï¼ˆCommand Categoriesï¼‰**

å”å®šæ›¸å°‡æ‰€æœ‰æŒ‡ä»¤åˆ†ç‚ºäº”å¤§ç¾¤ï¼š

---

### **A é¡ï¼šå°ˆæ¡ˆç”Ÿå‘½é€±æœŸæŒ‡ä»¤ï¼ˆProject Lifecycleï¼‰**

| æŒ‡ä»¤               | è²¬ä»»                           |
| ---------------- | ---------------------------- |
| `add_project`    | å»ºç«‹æ–°å°ˆæ¡ˆ                        |
| `edit_project`   | ä¿®æ”¹å°ˆæ¡ˆæ¬„ä½                       |
| `delete_project` | åˆªé™¤å°ˆæ¡ˆåŠæ‰€æœ‰é™„å±¬è³‡æºï¼ˆcascade cleanupï¼‰ |
| `list_projects`  | åˆ—å‡ºæ‰€æœ‰å°ˆæ¡ˆèˆ‡å…¶ç‹€æ…‹                   |

æ³•å¾‹æ•ˆæœï¼š

* å¿…é ˆå¯«å…¥ projects.json
* å¿…é ˆèµ° I/O Gateway
* å¿…é ˆé©—è­‰è·¯å¾‘æœ‰æ•ˆæ€§
* å¿…é ˆç”¢ç”Ÿå‚™ä»½

---

### **B é¡ï¼šç›®éŒ„æ¨¹æ›´æ–°æŒ‡ä»¤ï¼ˆManual Tree Updateï¼‰**

| æŒ‡ä»¤              |
| --------------- |
| `manual_update` |
| `manual_direct` |

æ³•å¾‹æ•ˆæœï¼š

* å‘¼å« engine.generate_annotated_tree()
* å¿…é ˆé©—è­‰ç›®æ¨™è·¯å¾‘å­˜åœ¨
* å¯«å…¥çµæœéœ€èµ° path/atomic_write

---

### **C é¡ï¼šå“¨å…µç”Ÿå‘½é€±æœŸæŒ‡ä»¤ï¼ˆSentry Lifecycleï¼‰**

| æŒ‡ä»¤             |
| -------------- |
| `start_sentry` |
| `stop_sentry`  |

æ³•å¾‹ç¾©å‹™ï¼š

* å•Ÿå‹•å“¨å…µ â†’ å»ºç«‹ `<uuid>.sentry` PID æˆ¶ç±æª”
* åœæ­¢å“¨å…µ â†’ åˆªé™¤æˆ¶ç±æª”
* å¿…é ˆé€²è¡Œæ®­å±è‡ªæ„ˆ
* stdout/stderr éœ€å°å‘ logs/<name>.log

---

### **D é¡ï¼šå“¨å…µå¯©è¨ˆï¼ˆMuting Auditï¼‰**

| æŒ‡ä»¤                    |
| --------------------- |
| `get_muted_paths`     |
| `add_ignore_patterns` |

æ³•å¾‹æ•ˆæœï¼š

* get_muted_paths â†’ è®€å– `/tmp/<uuid>.sentry_status`
* add_ignore_patterns â†’ æ¨å° patterns â†’ å¯«å…¥ projects.json â†’ åˆªé™¤ status file

---

### **E é¡ï¼šå¿½ç•¥è¦å‰‡ç®¡ç†ï¼ˆIgnore Patternsï¼‰**

| æŒ‡ä»¤                       |
| ------------------------ |
| `get_ignore_patterns`    |
| `update_ignore_patterns` |

æ³•å¾‹ç´„æŸï¼š

* åªå¯è®€å¯« projects.json
* ä¸å¾—æ¨æ¸¬ã€ä¸è‡ªå‹•æ·»åŠ ã€ä¸æ’åº
* æ±ºå®šæ¬Šå®Œå…¨å±¬æ–¼å‰ç«¯

---

# 4. å“¨å…µé€šä¿¡æ¨¡å‹ï¼ˆSentry Communication Modelï¼‰

å“¨å…µä¸å¯ç›´æ¥å‘¼å« daemonã€‚

å“¨å…µåªèƒ½é€é**ç‹€æ…‹æª”ï¼ˆstatus fileï¼‰**ä¸Šå ±ï¼š

```
/tmp/<uuid>.sentry_status
```

å…§å®¹æ ¼å¼ï¼š

```json
["/path/a", "/path/b"]
```

daemon å¿…é ˆï¼š

* åœ¨ list_projects æ™‚è®€å–ç‹€æ…‹æª”
* åœ¨ add_ignore_patterns æ™‚åˆªé™¤
* åœ¨ status å·²æ¶ˆå¤±æ™‚è¦–ç‚ºæ­£å¸¸

å“¨å…µä¸å¾—ï¼š

* ç”¢ç”Ÿ ignore patterns
* æ¸…é™¤è‡ªå·±çš„ status file
* ä¿®æ”¹ projects.json
* è§¸ç™¼ç›®éŒ„æ¨¹æ›´æ–°ï¼ˆéœ€ daemonï¼‰

---

# 5. I/O Gateway å¥‘ç´„ï¼ˆå”¯ä¸€è·¯å¾‘ï¼‰

æ‰€æœ‰å¯«å…¥è¡Œç‚ºå¿…é ˆé€éï¼š

```
safe_read_modify_write(path, callback)
```

ä¿éšœï¼š

* åŸå­æ€§
* å¯æ¢å¾©æ€§
* è‡ªæ„ˆèƒ½åŠ›
* ç‰ˆæœ¬å‚™ä»½ï¼ˆåƒ…ä¿ç•™æœ€è¿‘ 3 å€‹ï¼‰

ä»»ä½•ä¸èµ° gateway çš„å¯«å…¥çš†å±¬éæ³•ã€‚

---

# 6. éŒ¯èª¤ç¢¼è¦ç¯„ï¼ˆExit Code Specificationï¼‰

| é€€å‡ºç¢¼ | æ„ç¾©             |
| --- | -------------- |
| 0   | æˆåŠŸ             |
| 1   | ç”¨æˆ¶è¼¸å…¥éŒ¯èª¤         |
| 2   | è·¯å¾‘ä¸å­˜åœ¨          |
| 3   | I/O éŒ¯èª¤         |
| 4   | è³‡æ–™æ ¼å¼éŒ¯èª¤         |
| 5   | å“¨å…µéŒ¯èª¤           |
| 6   | æ¬Šé™ä¸è¶³           |
| 9   | ç³»çµ±ç´šæœªçŸ¥éŒ¯èª¤        |
| 10  | éœ€è¦å‰ç«¯é‡è©¦ï¼ˆI/O è‡ªæ„ˆï¼‰ |

---

# 7. ç‹€æ…‹å› æœéˆï¼ˆState Causality Graphï¼‰

é€™æ˜¯ç³»çµ±æœ€é—œéµçš„è¡Œç‚ºåºåˆ—ä¿è­‰ï¼š

```
[æª”æ¡ˆäº‹ä»¶] 
    â†’ sentry_workerï¼ˆSmartThrottlerï¼‰
        â†’ muted_paths æ›´æ–°
            â†’ status file æ›´æ–°
                â†’ daemon.list_projects è®€å–ç‹€æ…‹
                    â†’ å‰ç«¯é¡¯ç¤º muting ç‹€æ…‹
                        â†’ add_ignore_patternsï¼ˆå›ºåŒ–ï¼‰
                            â†’ projects.json æ›´æ–°
                                â†’ status file åˆªé™¤
```

ä¸èƒ½è·³æ­¥
ä¸èƒ½é€†è¡Œ
ä¸èƒ½åŒæ™‚ç”±å…©å€‹æ¨¡çµ„åšåŒä¸€ä»¶äº‹ã€‚

---

# 8. é™„éŒ„ï¼šæ­£å¼æŒ‡ä»¤åˆ—è¡¨ï¼ˆCanonical Commandsï¼‰

```
ping
list_projects

add_project <name> <path> <output_file>
edit_project <uuid> <field> <new_value>
delete_project <uuid>

manual_update <uuid>
manual_direct <path> <target_doc>

start_sentry <uuid>
stop_sentry <uuid>

get_muted_paths <uuid>
add_ignore_patterns <uuid>

get_ignore_patterns <uuid>
update_ignore_patterns <uuid> <patterns>
```


