# ==============================================================================
# æ¨¡çµ„è·è²¬ï¼šsentry_worker.py
#
# é€™å€‹æ¨¡çµ„è² è²¬ã€Œç¨ç«‹å“¨å…µé€²ç¨‹ï¼ˆSentry Workerï¼‰ã€çš„æ‰€æœ‰è¡Œç‚ºï¼Œ
# æ˜¯ç³»çµ±ä¸­å”¯ä¸€ç›´æ¥ç›£æ§æª”æ¡ˆç³»çµ±äº‹ä»¶çš„æ ¸å¿ƒå–®å…ƒã€‚
#
# ã€WHY â€” ç‚ºä»€éº¼éœ€è¦é€™å€‹æ¨¡çµ„ï¼Ÿã€‘
# - å¾Œç«¯å®ˆè­·é€²ç¨‹ï¼ˆdaemon.pyï¼‰ç„¡æ³•ç›´æ¥é€²è¡Œæª”æ¡ˆç›£æ§ï¼Œå› æ­¤éœ€è¦ä¸€å€‹ç¨ç«‹ã€å¯é‡å•Ÿã€
#   å¯éš”é›¢ã€å…·å‚™è‡ªç™’èƒ½åŠ›çš„ç›£æ§å­é€²ç¨‹ã€‚
# - å“¨å…µéœ€è¦èƒ½ã€Œè‡ªæˆ‘å­˜æ´»ã€ï¼Œä¸æœƒå› ä½¿ç”¨è€… Ctrl+C æˆ–ä¸»ç¨‹å¼å´©æ½°è€Œæ­»äº¡ã€‚
# - ç›£æ§éœ€è¦æä¾›å¯ä¿¡è¨Šè™Ÿä¾†æºï¼Œä»¥æ”¯æ´ã€Œæ™ºèƒ½éœé»˜ã€ã€ã€Œå¯©è¨ˆå›ºåŒ–ã€ã€ã€Œäº‹ä»¶å›é¥‹ã€ã€‚
#
# ã€WHAT â€” é€™å€‹æ¨¡çµ„å¯¦ç¾äº†ä»€éº¼ï¼Ÿã€‘
# 1. æ¡ç”¨ PollingObserver çš„ã€Œå¯é è¼ªè©¢ã€ç›£æ§æ¨¡å¼ï¼ˆé¿å… inotify çš„ä¾·é™ï¼‰
# 2. äº‹ä»¶äº”éšæ®µè™•ç†æµç¨‹ï¼š
#       (1) R5 çµæ§‹æ€§é˜²ç«ç‰† â†’ é˜»æ“‹ç¦å€è·¯å¾‘
#       (2) OUTPUT-FILE-BLACKLIST â†’ é˜»æ“‹è‡ªè§¸ç™¼äº‹ä»¶ï¼ˆé¿å…ç›£æ§è¿´åœˆï¼‰
#       (3) SmartThrottler â†’ R1/R3/R4 ä¸‰å¤§æ™ºèƒ½éœé»˜è¦å‰‡
#       (4) éœé»˜åˆ—è¡¨ï¼ˆmuted_pathsï¼‰ç‹€æ…‹éƒµç®±å¯«å…¥
#       (5) å° daemon.py ç™¼é€å›å ±ï¼Œè§¸ç™¼å¾Œç«¯æ›´æ–°
# 3. å®Œæ•´çš„è¨ºæ–·æ¢é‡ï¼ˆv1.0 & v2.0ï¼‰ï¼Œæä¾›å¯è§€å¯Ÿæ€§ï¼ˆObservabilityï¼‰
# 4. SIGINT å¿½ç•¥æ©Ÿåˆ¶ï¼ˆå“¨å…µæ±‚ç”Ÿæœ¬èƒ½ï¼‰ï¼šé¿å…è¢« Ctrl+C æ®ºæ­»
#
# ã€HOW â€” é€™å€‹æ¨¡çµ„æ˜¯å¦‚ä½•åšåˆ°çš„ï¼Ÿã€‘
# - ä½¿ç”¨ watchdog + PollingObserver é€²è¡Œè·¨å¹³å°ç©©å®šç›£æ§
# - ä»¥ JSON å¯«å…¥ /tmp/<uuid>.sentry_status å›å ± muted_paths
# - é€é SmartThrottler åˆ†æäº‹ä»¶è¡Œç‚ºï¼ˆé »ç‡ã€å‰µå»ºé‡ã€é«”ç©è®ŠåŒ–ï¼‰
# - ä»¥å…¨å±€ç¦å€ SENTRY_INTERNAL_IGNORE éæ¿¾è‡ªèº«è·¯å¾‘èˆ‡ç³»çµ±è·¯å¾‘
# - ä»¥ daemon.handle_manual_update() ä¸²æ¥å¾Œç«¯æ›´æ–°æµç¨‹
#
# TAG: DEFENSE
# - å¿½ç•¥ SIGINTï¼Œä»¥é˜²å“¨å…µå› å‰ç«¯ Ctrl+C æ„å¤–æ­»äº¡
# - ä½¿ç”¨ OUTPUT-FILE-BLACKLIST é¿å…ç›£æ§è‡ªèº«å¯«å…¥è¡Œç‚º
#
# TAG: HACK
# - ç‚ºäº†åœ¨ç¨ç«‹å­é€²ç¨‹ä¸­å°å…¥å°ˆæ¡ˆè·¯å¾‘ï¼Œæ¡ç”¨äº† sys.path.insert çš„æœ€å°å…¨åŸŸä¿®è£œ
#
# VERSION: v9.1 â€” é‡ç”Ÿç‰ˆï¼ˆReborn Editionï¼‰
# ==============================================================================


# ==============================================================================
# ä¾è³´æ¨¡çµ„å°å…¥å€ï¼ˆImportsï¼‰
#
# æˆ‘å€‘å°‡æ‰€éœ€çš„æ‰€æœ‰å·¥å…·æŒ‰ã€Œç”¨é€”ã€åˆ†çµ„å°å…¥ï¼Œè®“è®€è€…èƒ½å¿«é€Ÿç†è§£æ¯å€‹æ¨¡çµ„
# åœ¨å“¨å…µç›£æ§ï¼ˆSentry Workerï¼‰ä¸­æ‰®æ¼”çš„è§’è‰²ã€‚
# ==============================================================================

# --- Python æ¨™æº–åº«ï¼šç³»çµ±èˆ‡æ™‚é–“æ§åˆ¶ ---
import sys        # ç”¨æ–¼èª¿æ•´æ¨¡çµ„æœå°‹è·¯å¾‘ã€è™•ç† stdin/stdoutï¼Œä»¥åŠæ•æ‰å•Ÿå‹•åƒæ•¸ã€‚
import time       # ç”¨æ–¼äº‹ä»¶ç¯€æµï¼ˆthrottlingï¼‰èˆ‡ç¡çœ ï¼ˆsleepï¼‰æ“ä½œã€‚
import os         # ç”¨æ–¼æª”æ¡ˆè·¯å¾‘æ‹¼æ¥ã€å­˜åœ¨æ€§åˆ¤æ–·èˆ‡äº‹ä»¶è·¯å¾‘è§£æã€‚
import signal     # ç”¨æ–¼å¿½ç•¥ Ctrl+Cï¼ˆSIGINTï¼‰ï¼Œç¢ºä¿å“¨å…µå­é€²ç¨‹ä¸è¢«èª¤æ®ºã€‚
import json       # ç”¨æ–¼å°‡ muted_paths ç‹€æ…‹åºåˆ—åŒ–åˆ° .sentry_statusï¼ˆéƒµç®±ç³»çµ±ï¼‰ã€‚
from typing import Set, Dict, List, Tuple, Optional  # ç”¨æ–¼å‹åˆ¥è¨»è§£ï¼Œæå‡å¯è®€æ€§èˆ‡ç©©å®šæ€§ã€‚
from datetime import datetime, timedelta            # ç”¨æ–¼äº‹ä»¶æ™‚é–“æˆ³èˆ‡è¦å‰‡è¨ˆç®—ï¼ˆR1/R4ï¼‰ã€‚

# --------------------------------------------------------------------------
# ã€ä¿®æ­£ Aã€‘æœ€çµ‚ç·¨ç¢¼ä¿®æ­£ï¼šå¼·åˆ¶ Windows ä¸Šçš„æ¨™æº–è¼¸å‡ºç‚º UTF-8
# --------------------------------------------------------------------------
if sys.platform == 'win32':
    import io
    # é€™æœƒå°‡æ¨™æº–è¼¸å‡º (sys.stdout) é‡æ–°é…ç½®ç‚ºä½¿ç”¨ UTF-8 ç·¨ç¢¼ï¼Œè§£æ±ºäº‚ç¢¼å•é¡Œ
    # æˆ‘å€‘åªåœ¨ Windows ä¸ŠåŸ·è¡Œæ­¤æ“ä½œï¼Œä»¥ä¿æŒç¨‹å¼ç¢¼åœ¨ POSIX ä¸Šçš„æ•´æ½”
    try:
        sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
        sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')
    except Exception:
        # å¦‚æœé‡é…ç½®å¤±æ•—ï¼Œæˆ‘å€‘å°±éœé»˜å¿½ç•¥ï¼Œè®“å®ƒä¿æŒåŸæ¨£
        pass

# --- ç¬¬ä¸‰æ–¹åº«ï¼šCross-platform æ–‡ä»¶ç³»çµ±ç›£æ§ ---
from watchdog.events import FileSystemEventHandler   # æä¾›äº‹ä»¶å›å‘¼ï¼ˆon_modified, on_created...ï¼‰
from watchdog.observers.polling import PollingObserver  
# æˆ‘å€‘ä½¿ç”¨ PollingObserverï¼Œè€Œä¸ä½¿ç”¨ inotifyï¼š
#   - é¿å… Linux inotify è·¨å¹³å°é™åˆ¶
#   - é¿å…å¤§é‡äº‹ä»¶æ¼å ±å•é¡Œ
#   - é¿å…ç¡¬ç¢Ÿæ›è¼‰é»ï¼ˆmountpointsï¼‰å°è‡´äº‹ä»¶ä¸Ÿå¤±
#   - æä¾›ä¸€è‡´çš„è¼ªè©¢å¼ï¼ˆpollingï¼‰å¯é è¡Œç‚º


# ==============================================================================
# æ ¸å¿ƒé…ç½®å€ï¼ˆCore Configurationï¼‰
# ==============================================================================

# DEFENSE:
# æˆ‘å€‘å‘Šè¨´ä½œæ¥­ç³»çµ±ï¼šé€™å€‹å­é€²ç¨‹ï¼ˆå“¨å…µï¼‰å¿…é ˆå¿½ç•¥ SIGINTï¼ˆCtrl + Cï¼‰ã€‚
# é€™èƒ½é¿å…ã€Œå‰ç«¯ä¸»ç¨‹å¼è¢«ä½¿ç”¨è€…æŒ‰ Ctrl+C çµ‚æ­¢ â†’ å“¨å…µä¹Ÿè¢«èª¤æ®ºã€çš„ç½é›£æ€§æƒ…æ³ã€‚
signal.signal(signal.SIGINT, signal.SIG_IGN)

# DEFENSE:
# é€™æ˜¯ä¸€é“ã€Œçµæ§‹æ€§é˜²ç«ç‰†ï¼ˆStructural Firewallï¼‰ã€ã€‚
# ä»»ä½•å±¬æ–¼ç³»çµ±è‡ªèº«çš„æª”æ¡ˆï¼ç›®éŒ„ï¼Œéƒ½ä¸èƒ½ä½œç‚ºç›£æ§äº‹ä»¶ä¾†æºï¼Œå¦å‰‡æœƒè§¸ç™¼ã€Œè‡ªæˆ‘ç›£æ§ã€æˆ–ã€Œç›£æ§è¿´åœˆã€ã€‚
#
# WHY:
# - é¿å…ç›£æ§åˆ°è‡ªå·±çš„ç‹€æ…‹æ–‡ä»¶ï¼ˆ.sentry_statusï¼‰
# - é¿å…ç›£æ§ temp/ èˆ‡å‚™ä»½æª”ï¼ˆ.bakï¼‰
# - é¿å…ç›£æ§ logs/ï¼ˆå¦å‰‡å“¨å…µå¯«å…¥ log â†’ åˆè¢«å“¨å…µç›£æ§ â†’ ç„¡é™è¿´åœˆï¼‰
# - é¿å…ç›£æ§ data/ å°ˆæ¡ˆè³‡æ–™ã€.gitã€__pycache__ ç­‰ç³»çµ±å€
SENTRY_INTERNAL_IGNORE = (
    '.sentry_status',
    'temp',
    'README.md',
    'logs',
    'data',
    '.git',
    '__pycache__',
    '.venv',
    '.vscode',
)

# å°ˆæ¡ˆè‡ªèº«æ ¹ç›®éŒ„ï¼ˆproject_rootï¼‰æœƒåœ¨å¾ŒçºŒåˆå§‹åŒ–éšæ®µå‹•æ…‹å»ºç«‹ï¼Œ
# ç”¨æ–¼åµæ¸¬ã€Œæ˜¯å¦æ­£åœ¨ç›£æ§è‡ªå·±çš„ä¾†æºç›®éŒ„ã€ã€‚


# ==============================================================================
# SmartThrottlerï¼šæ™ºèƒ½æŠ‘åˆ¶å™¨ï¼ˆv1.0 - é‡ç”Ÿç‰ˆï¼‰
# ==============================================================================
class SmartThrottler:
    """
    æ™ºèƒ½æŠ‘åˆ¶å™¨ï¼ˆSmart Throttlerï¼‰

    WHYï¼ˆç‚ºä»€éº¼éœ€è¦ï¼Ÿï¼‰
    --------------------
    æˆ‘å€‘ä¸å¸Œæœ›å“¨å…µè¢«ã€Œå¤§é‡ã€çŸ­æ™‚é–“ã€ç•°å¸¸ã€çš„æª”æ¡ˆäº‹ä»¶æ·¹æ²’ï¼Œ
    å› æ­¤ SmartThrottler å°ˆé–€ç”¨ä¾†æª¢æ¸¬ï¼š
    - å–®æª”æ¡ˆçŸ­æ™‚é–“å…§çš„éç†±ä¿®æ”¹ï¼ˆR1ï¼‰
    - å–®è³‡æ–™å¤¾çš„çˆ†é‡å‰µå»ºï¼ˆR3ï¼‰
    - å–®æª”æ¡ˆåœ¨çŸ­æ™‚é–“å…§ã€Œé«”ç©ç•°å¸¸è†¨è„¹ã€ï¼ˆR4ï¼‰

    WHATï¼ˆå®ƒåšä»€éº¼ï¼Ÿï¼‰
    -------------------
    - ç‚ºæ¯å€‹è·¯å¾‘ç¶­è­·è¡Œç‚ºæ™‚é–“åºåˆ—
    - æ ¹æ“šä¸‰ç¨®è¦å‰‡æ±ºå®šæ˜¯å¦éœ€è¦ã€Œéœé»˜ï¼ˆmutingï¼‰ã€è©²è·¯å¾‘
    - å°‡è¢«éœé»˜çš„è·¯å¾‘åŠ å…¥ muted_pathsï¼Œä¾›äº‹ä»¶è™•ç†å™¨ä½¿ç”¨

    HOWï¼ˆå®ƒæ€éº¼åšï¼Ÿï¼‰
    -------------------
    - ä½¿ç”¨ datetime timestamp å»ºç«‹äº‹ä»¶æ™‚é–“çª—
    - ä½¿ç”¨å¯èª¿æ•´çš„é–¾å€¼ï¼ˆthresholdï¼‰èˆ‡è§€å¯ŸæœŸï¼ˆperiodï¼‰
    - ç‚ºæ¯æ¢è·¯å¾‘å»ºç«‹ç¨ç«‹çš„æ­·å²è¡Œç‚ºè³‡æ–™è¡¨
    """

    def __init__(self,
                burst_creation_threshold: int = 20,
                burst_creation_period_seconds: float = 10.0,
                size_growth_threshold_mb: int = 100,
                size_growth_period_seconds: float = 60.0):

        # ----------------------------------------------------------------------
        # R1ï¼šå–®æª”éç†±è¦å‰‡ï¼ˆHot File Ruleï¼‰
        # ----------------------------------------------------------------------
        # å¦‚æœåŒä¸€å€‹æª”æ¡ˆåœ¨ hot_period å…§è¢«ä¿®æ”¹è¶…é hot_threshold æ¬¡ï¼Œ
        # æˆ‘å€‘æ¨å®šè©²æª”æ¡ˆè™•æ–¼ã€Œéç†±ã€ç‹€æ…‹ï¼Œæ‡‰è©²è‡¨æ™‚éœé»˜ã€‚
        self.hot_threshold = 5                    # æ™‚é–“çª—å…§å…è¨±çš„æœ€å¤§äº‹ä»¶æ•¸
        self.hot_period = timedelta(seconds=5.0)  # æ™‚é–“çª—ï¼ˆ5 ç§’ï¼‰
        self.hot_events: Dict[str, List[datetime]] = {}   # {file_path: [timestamps...]}

        # ----------------------------------------------------------------------
        # R3ï¼šçˆ†é‡å‰µå»ºè¦å‰‡ï¼ˆBurst Creation Ruleï¼‰
        # ----------------------------------------------------------------------
        # å¦‚æœæŸå€‹è³‡æ–™å¤¾åœ¨çŸ­æ™‚é–“å…§ç´¯ç©å¤ªå¤šã€Œcreatedã€äº‹ä»¶ï¼Œ
        # ä»£è¡¨å¯èƒ½æœ‰å·¥å…·ç”¢ç”Ÿå¤§é‡æª”æ¡ˆï¼ˆå¦‚ node_modulesã€cacheï¼‰ã€‚
        self.burst_creation_threshold = burst_creation_threshold
        self.burst_creation_period = timedelta(seconds=burst_creation_period_seconds)
        self.creation_timestamps: Dict[str, List[datetime]] = {}  # {dir_path: [timestamps...]}

        # ----------------------------------------------------------------------
        # R4ï¼šé«”ç©ç•°å¸¸æˆé•·è¦å‰‡ï¼ˆAbnormal Size Growth Ruleï¼‰
        # ----------------------------------------------------------------------
        # å¦‚æœæŸæª”æ¡ˆåœ¨ size_growth_period å…§æˆé•·è¶…éæŒ‡å®šé–¾å€¼ï¼ˆé è¨­ 100MBï¼‰ï¼Œ
        # é€šå¸¸ä»£è¡¨ log æµå¤±æ§æˆ–å£“ç¸®å‰çš„æš«å­˜æª”æš´æ¼² â†’ å¿…é ˆéœé»˜ã€‚
        self.size_growth_threshold_bytes = size_growth_threshold_mb * 1024 * 1024
        self.size_growth_period = timedelta(seconds=size_growth_period_seconds)
        self.size_history: Dict[str, List[Tuple[datetime, int]]] = {}  # {file_path: [(ts, size), ...]}

        # ----------------------------------------------------------------------
        # å…¨åŸŸéœé»˜é»‘åå–®ï¼ˆMuted Pathsï¼‰
        # ----------------------------------------------------------------------
        # åªè¦æŸå€‹è·¯å¾‘è¢«ä»»ä½•è¦å‰‡åˆ¤å®šç‚ºç•°å¸¸ï¼Œå°±æœƒè¢«åŠ å…¥é€™è£¡ã€‚
        self.muted_paths: Set[str] = set()

    def should_process(self, event) -> bool:
        """
        æ ¹æ“šã€Œä¸‰å¤§æ™ºèƒ½è¦å‰‡ (R1/R3/R4)ã€èˆ‡éœé»˜åå–®ï¼Œ
        åˆ¤æ–·ä¸€å€‹æª”æ¡ˆç³»çµ±äº‹ä»¶æ˜¯å¦æ‡‰è©²è¢«é€²ä¸€æ­¥è™•ç†ã€‚

        WHY:
        ----
        - å“¨å…µæ¯ç§’å¯èƒ½æ”¶åˆ°æ•¸ç™¾ç­†äº‹ä»¶ï¼Œä¸èƒ½å…¨éƒ¨è™•ç†ã€‚
        - SmartThrottler æœƒæ ¹æ“šç•°å¸¸è¡Œç‚ºï¼ˆéç†±ã€çˆ†é‡ã€é«”ç©æš´æ¼²ï¼‰
        æ±ºå®šæ˜¯å¦å°‡è·¯å¾‘åŠ å…¥éœé»˜åå–®ã€‚

        WHAT:
        -----
        - å°å‡ºå¯è§€å¯Ÿæ€§è¨ºæ–·è³‡è¨Šï¼ˆProbe v1.0ï¼‰
        - ä¾åºå¥—ç”¨ï¼š
        (1) éœé»˜åå–®
        (2) R1ï¼šå–®æª”éç†±
        (3) R3ï¼šçˆ†é‡å‰µå»º
        (4) R4ï¼šé«”ç©ç•°å¸¸å¢é•·

        HOW:
        ----
        - ä½¿ç”¨æ™‚é–“çª—ï¼ˆtimestamp windowï¼‰è™•ç†äº‹ä»¶è¡Œç‚ºåºåˆ—
        - è‹¥ä»»ä¸€è¦å‰‡è§¸ç™¼ï¼Œå°‡è·¯å¾‘åŠ å…¥ muted_paths ä¸¦å›å‚³ False
        """

        path = event.src_path
        now = datetime.now()

        # ----------------------------------------------------------------------
        # ã€è¨ºæ–·æ¢é‡ v1.0ã€‘é¡¯ç¤ºäº‹ä»¶ä¾†æºèˆ‡æ™‚é–“
        # ----------------------------------------------------------------------
        print(f"ğŸ•µï¸ PID:{os.getpid()} [{now.strftime('%H:%M:%S.%f')}] æ”¶åˆ°äº‹ä»¶: {event.event_type} @ '{os.path.basename(path)}'")
        sys.stdout.flush()

        # ----------------------------------------------------------------------
        # 1. é€šç”¨è¦å‰‡ï¼šè‹¥è·¯å¾‘æˆ–å…¶çˆ¶ç›®éŒ„å·²åœ¨éœé»˜åå–® â†’ ç›´æ¥æ‹’çµ•
        # ----------------------------------------------------------------------
        if path in self.muted_paths or os.path.dirname(path) in self.muted_paths:
            print(f"  -> æ±ºç­–: æ‹’çµ• (è·¯å¾‘å·²åœ¨éœé»˜é»‘åå–®ä¸­)")
            sys.stdout.flush()
            return False

        # ----------------------------------------------------------------------
        # 2. R1 è¦å‰‡ï¼šå–®æª”ã€ŒçŸ­æ™‚é–“å…§éç†±ã€çš„ç•°å¸¸ä¿®æ”¹
        # ----------------------------------------------------------------------
        if event.event_type == 'modified':
            timestamps_r1 = self.hot_events.get(path, [])
            valid_timestamps_r1 = [t for t in timestamps_r1 if now - t < self.hot_period]
            valid_timestamps_r1.append(now)
            self.hot_events[path] = valid_timestamps_r1

            print(f"  -> R1 è¨ˆæ•¸: æ–‡ä»¶ '{os.path.basename(path)}' çš„ä¿®æ”¹äº‹ä»¶è¨ˆæ•¸ç‚º {len(valid_timestamps_r1)} / {self.hot_threshold}")
            sys.stdout.flush()

            if len(valid_timestamps_r1) >= self.hot_threshold:
                print(f"ğŸ”¥ [æ™ºèƒ½éœé»˜ R1] åµæ¸¬åˆ°æ–‡ä»¶ '{path}' åœ¨çŸ­æ™‚é–“å…§äº‹ä»¶éå¤šï¼Œå·²å°‡å…¶è‡¨æ™‚éœé»˜ã€‚")
                self.muted_paths.add(path)
                # R1 å‘½ä¸­å¾Œæ¸…ç†è¨˜éŒ„ï¼Œé¿å…è³‡æ–™è†¨è„¹
                self.hot_events.pop(path, None)
                return False

        # ----------------------------------------------------------------------
        # 3. R3 è¦å‰‡ï¼šæŸè³‡æ–™å¤¾åœ¨çŸ­æ™‚é–“å…§çˆ†é‡å‰µå»ºæª”æ¡ˆ
        # ----------------------------------------------------------------------
        if event.event_type == 'created':
            dir_path = os.path.dirname(path)
            timestamps = self.creation_timestamps.get(dir_path, [])
            valid_timestamps = [t for t in timestamps if now - t < self.burst_creation_period]
            valid_timestamps.append(now)
            self.creation_timestamps[dir_path] = valid_timestamps

            print(f"  -> R3 è¨ˆæ•¸: ç›®éŒ„ '{os.path.basename(dir_path)}' çš„å‰µå»ºäº‹ä»¶è¨ˆæ•¸ç‚º {len(valid_timestamps)} / {self.burst_creation_threshold}")
            sys.stdout.flush()

            if len(valid_timestamps) > self.burst_creation_threshold:
                print(f"ğŸ”¥ [æ™ºèƒ½éœé»˜ R3] åµæ¸¬åˆ°ç›®éŒ„ '{dir_path}' ç™¼ç”Ÿçˆ†é‡å‰µå»ºï¼Œå·²å°‡å…¶è‡¨æ™‚éœé»˜ã€‚")
                self.muted_paths.add(dir_path)
                return False

        # ----------------------------------------------------------------------
        # 4. R4 è¦å‰‡ï¼šæ–‡ä»¶é«”ç©åœ¨çŸ­æ™‚é–“å…§ç•°å¸¸æš´æ¼²ï¼ˆä¾‹å¦‚å¤±æ§ logï¼‰
        # ----------------------------------------------------------------------
        if event.event_type == 'modified':
            try:
                current_size = os.stat(path).st_size
                history = self.size_history.get(path, [])
                valid_history = [h for h in history if now - h[0] < self.size_growth_period]

                initial_size = valid_history[0][1] if valid_history else 0
                growth = current_size - initial_size

                print(f"  -> R4 æª¢æ¸¬: æ–‡ä»¶ '{os.path.basename(path)}' é«”ç©å¢é•· {growth / (1024*1024):.2f} MB / {self.size_growth_threshold_bytes / (1024*1024):.2f} MB")
                sys.stdout.flush()

                if valid_history and growth > self.size_growth_threshold_bytes:
                    print(f"ğŸ”¥ [æ™ºèƒ½éœé»˜ R4] åµæ¸¬åˆ°æ–‡ä»¶ '{path}' é«”ç©ç•°å¸¸å¢é•·ï¼Œå·²å°‡å…¶è‡¨æ™‚éœé»˜ã€‚")
                    self.muted_paths.add(path)
                    return False

                valid_history.append((now, current_size))
                self.size_history[path] = valid_history

            except (FileNotFoundError, IndexError):
                # è‹¥äº‹ä»¶ç™¼ç”Ÿæ™‚æª”æ¡ˆæ¶ˆå¤±ï¼Œé‡æ–°å»ºç«‹è¨˜éŒ„
                self.size_history[path] = [(now, current_size)]
            except Exception as e:
                print(f"âš ï¸ [SmartThrottler] åœ¨æª¢æŸ¥æ–‡ä»¶é«”ç©æ™‚å‡ºéŒ¯: {e}", file=sys.stderr)

        # ----------------------------------------------------------------------
        # 5. æ‰€æœ‰æª¢æŸ¥å‡æœªå‘½ä¸­ â†’ æ”¾è¡Œ
        # ----------------------------------------------------------------------
        print(f"  -> æœ€çµ‚æ±ºç­–: æ”¾è¡Œ")
        sys.stdout.flush()
        return True

# ==============================================================================
# å°ˆæ¡ˆè·¯å¾‘æ³¨å…¥ï¼ˆProject Path Injectionï¼‰
# ==============================================================================

# HACK:
# watchdog å­é€²ç¨‹çš„å·¥ä½œç›®éŒ„ï¼ˆcwdï¼‰ä¸¦ä¸ç­‰æ–¼å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼Œå°è‡´ç„¡æ³•ç›´æ¥ import src.core.daemonã€‚
# ç‚ºäº†è®“å“¨å…µèƒ½èª¿ç”¨å¾Œç«¯ daemon APIï¼ˆhandle_manual_updateï¼‰ï¼Œæˆ‘å€‘éœ€è¦å°‡å°ˆæ¡ˆæ ¹ç›®éŒ„
# æ‰‹å‹•åŠ å…¥ sys.pathã€‚é€™æ˜¯ä¸€å€‹æœ€å°åŒ–ã€å¯æ¥å—çš„å…¨åŸŸä¿®è£œã€‚
project_root_for_import = os.path.abspath(os.path.join(os.path.dirname(__file__), '..', '..'))
if project_root_for_import not in sys.path:
    sys.path.insert(0, project_root_for_import)

from src.core import daemon


# ==============================================================================
# SentryEventHandlerï¼šå“¨å…µäº‹ä»¶è™•ç†å™¨ï¼ˆv9.1 - é‡ç”Ÿç‰ˆï¼‰
# ==============================================================================
class SentryEventHandler(FileSystemEventHandler):
    """
    WHYï¼ˆç‚ºä»€éº¼éœ€è¦ï¼Ÿï¼‰
    --------------------
    - SmartThrottler åšã€Œæ±ºç­–ã€ï¼Œä½†ä¸è² è²¬ã€Œäº‹æƒ…å¾Œè¦åšä»€éº¼ã€ã€‚
    - SentryEventHandler æ˜¯å“¨å…µçš„ä¸»æ§ä¸­æ¨ï¼Œè² è²¬ï¼š
        * å¥—ç”¨ R5 çµæ§‹æ€§é˜²ç«ç‰†ï¼ˆé˜»æ“‹å±éšªè·¯å¾‘ï¼‰
        * é˜»æ“‹ output_file è‡ªè§¸ç™¼äº‹ä»¶ï¼ˆé¿å…ç›£æ§è¿´åœˆï¼‰
        * å‘¼å«æ™ºèƒ½æŠ‘åˆ¶å™¨ï¼ˆR1 / R3 / R4ï¼‰
        * å¯«å…¥ .sentry_statusï¼ˆå“¨å…µéƒµç®±ï¼‰
        * å›å ± daemonï¼Œè§¸ç™¼å¾Œç«¯æ›´æ–°

    WHATï¼ˆå®ƒåšä»€éº¼ï¼Ÿï¼‰
    -------------------
    - å°æ¯ç­†äº‹ä»¶å¥—ç”¨ä¸€æ•´æ¢å®‰å…¨ç®¡ç·šï¼ˆFirewall â†’ Throttler â†’ Status â†’ Updateï¼‰
    - è‹¥äº‹ä»¶å®‰å…¨ â†’ è§¸ç™¼ daemon.handle_manual_update

    HOWï¼ˆå®ƒæ€éº¼åšï¼Ÿï¼‰
    -------------------
    - on_any_event æ˜¯ watchdog çš„çµ±ä¸€äº‹ä»¶å…¥å£
    - æ‰€æœ‰äº‹ä»¶åœ¨é€²å…¥ SmartThrottler å‰å…ˆé€šé R5 é˜²ç«ç‰†
    - ä½¿ç”¨ OUTPUT-FILE-BLACKLIST é¿å…ç›£æ§è‡ªå·±å¯«å‡ºçš„ output_file
    """

    def __init__(self, throttler: SmartThrottler, project_uuid: str,
                output_file_paths: Optional[List[str]] = None):

        self.throttler = throttler
        self.project_uuid = project_uuid

        # ç”¨æ–¼åµæ¸¬ã€Œmuted_paths æ˜¯å¦è®Šå‹•ã€ä»¥æ±ºå®šæ˜¯å¦å¯«å…¥ .sentry_status
        self._last_muted_paths_state: Set[str] = set()

        # DEFENSE:
        # OUTPUT-FILE-BLACKLISTï¼šåªè¦æ˜¯ output_file æœ¬èº«ï¼ˆç³»çµ±å¯«å…¥çš„çµæœï¼‰
        # å°±å¿…é ˆæ°¸é å¿½ç•¥ï¼Œå¦å‰‡ã€Œå¯«æª” â†’ è§¸ç™¼äº‹ä»¶ â†’ åˆå¯«æª”ã€æœƒå½¢æˆç›£æ§è¿´åœˆã€‚
        self.output_file_paths = set(output_file_paths) if output_file_paths else set()


    # --------------------------------------------------------------------------
    # watchdog çš„ç¸½å…¥å£ï¼šæ‰€æœ‰äº‹ä»¶éƒ½æœƒå…ˆé€²ä¾†é€™è£¡
    # --------------------------------------------------------------------------
    def on_any_event(self, event):

        # ----------------------------------------------------------------------
        # æ­¥é©Ÿ 1ï¼šR5 çµæ§‹æ€§é˜²ç«ç‰†ï¼ˆStructural Firewallï¼‰
        # ----------------------------------------------------------------------
        # è·³éæ‰€æœ‰ç›®éŒ„äº‹ä»¶ï¼ˆæˆ‘å€‘åªé—œå¿ƒæª”æ¡ˆè®Šå‹•ï¼‰
        if event.is_directory:
            return

        if isinstance(event.src_path, str):
            # å°‡è·¯å¾‘æ‹†æˆå¤šå€‹ç‰‡æ®µï¼ˆä¾‹å¦‚ /path/to/temp/x â†’ ["path","to","temp","x"]ï¼‰
            normalized_path = os.path.normpath(event.src_path)
            path_parts = normalized_path.split(os.sep)

            # è‹¥ä»»ä¸€ç‰‡æ®µå±¬æ–¼ SENTRY_INTERNAL_IGNOREï¼Œå°±å¿…é ˆæ‹’çµ•
            if any(part in SENTRY_INTERNAL_IGNORE for part in path_parts):
                return  # éœé»˜æ‹’çµ•ï¼Œä¸å¯« logï¼ˆé€™æ˜¯åˆ»æ„è¨­è¨ˆçš„ï¼‰


        # ----------------------------------------------------------------------
        # æ­¥é©Ÿ 1.5ï¼šOUTPUT-FILE-BLACKLISTï¼ˆé¿å…ç›£æ§è¿´åœˆï¼‰
        # ----------------------------------------------------------------------
        # è‹¥é€™å€‹äº‹ä»¶ä¾†è‡ª output_file â†’ ç›´æ¥å¿½ç•¥
        if normalized_path in self.output_file_paths:
            return


        # ----------------------------------------------------------------------
        # æ­¥é©Ÿ 2ï¼šäº¤çµ¦æ™ºèƒ½æŠ‘åˆ¶å™¨ï¼ˆR1 / R3 / R4ï¼‰
        # ----------------------------------------------------------------------
        should_proceed = self.throttler.should_process(event)


        # ----------------------------------------------------------------------
        # æ­¥é©Ÿ 3ï¼šéƒµç®±æ›´æ–°ï¼ˆç„¡æ¢ä»¶åŸ·è¡Œï¼‰
        # ----------------------------------------------------------------------
        # è‹¥ muted_paths æœ‰è®Šå‹• â†’ å¯«å…¥ temp/<uuid>.sentry_status
        self._check_and_update_status_file()


        # ----------------------------------------------------------------------
        # æ­¥é©Ÿ 4ï¼šè‹¥é€šéæ‰€æœ‰æª¢æŸ¥ â†’ åŸ·è¡Œæ ¸å¿ƒæ›´æ–°
        # ----------------------------------------------------------------------
        if should_proceed:
            print(f"[{time.strftime('%H:%M:%S')}] [å®‰å…¨äº‹ä»¶] åµæ¸¬åˆ°: {event.event_type} - è·¯å¾‘: {event.src_path}")
            sys.stdout.flush()
            daemon.handle_manual_update([self.project_uuid])


    def _check_and_update_status_file(self):
        """
        æª¢æŸ¥éœé»˜åˆ—è¡¨ï¼ˆmuted_pathsï¼‰æ˜¯å¦ç™¼ç”Ÿè®ŠåŒ–ï¼Œ
        è‹¥æœ‰è®ŠåŒ–ï¼Œä¾¿å°‡å…¶å¯«å…¥å°ˆæ¡ˆå°ˆå±¬çš„å“¨å…µéƒµç®±ï¼ˆ.sentry_statusï¼‰ã€‚

        WHYï¼š
        -----
        - SmartThrottler çš„æ±ºç­–çµæœï¼ˆmuted_pathsï¼‰å¿…é ˆå›å‚³çµ¦ daemon
        æ‰èƒ½è®“å¾Œç«¯çŸ¥é“ã€Œå“ªäº›è·¯å¾‘å·²è¢«è‡¨æ™‚éœé»˜ã€ã€‚
        - å“¨å…µå¿…é ˆé€éæª”æ¡ˆï¼ˆtemp/<uuid>.sentry_statusï¼‰é€²è¡Œè¨Šè™Ÿå‚³éï¼Œ
        å› ç‚ºå­é€²ç¨‹ç„¡æ³•ç›´æ¥ä¿®æ”¹çˆ¶é€²ç¨‹çš„è¨˜æ†¶é«”ç‹€æ…‹ã€‚

        WHATï¼š
        ------
        - æª¢æŸ¥éœé»˜åå–®æ˜¯å¦è®Šå‹•ï¼ˆé¿å…åè¦†å¯«æª”ï¼‰
        - å¯«å…¥ JSON æ ¼å¼çš„ mutated paths åˆ—è¡¨
        - å°è¨ºæ–·æ¢é‡è¨Šæ¯ï¼ˆProbe v2.0ï¼‰

        HOWï¼š
        -----
        - ä½¿ç”¨æœ¬åœ° /tmp/<uuid>.sentry_status ä½œç‚ºå“¨å…µéƒµç®±
        - åªæœ‰éœé»˜åå–®è®Šå‹•æ™‚æ‰å¯«å…¥ï¼Œé¿å…ç£ç¢Ÿ I/O éé‡
        """

        current_muted_paths = self.throttler.muted_paths

        # ------------------------------------------------------------------
        # è‹¥éœé»˜åå–®èˆ‡ä¸Šæ¬¡è¨˜éŒ„ä¸åŒ â†’ å¿…é ˆå¯«å…¥éƒµç®±
        # ------------------------------------------------------------------
        if current_muted_paths != self._last_muted_paths_state:

            print(f"ğŸ“« [{time.strftime('%H:%M:%S')}] [æƒ…å ±æ›´æ–°] éœé»˜åˆ—è¡¨è®ŠåŒ–ï¼Œæ­£åœ¨å¯«å…¥éƒµç®±: {list(current_muted_paths)}")
            sys.stdout.flush()

            status_file_path = f"/tmp/{self.project_uuid}.sentry_status"

            try:
                # å°‡éœé»˜åå–®å¯«å…¥å“¨å…µéƒµç®±ï¼ˆç‹€æ…‹æª”ï¼‰
                with open(status_file_path, 'w', encoding='utf-8') as f:
                    json.dump(list(current_muted_paths), f)

                # ------------------------------------------------------------------
                # ã€è¨ºæ–·æ¢é‡ v2.0ã€‘æˆåŠŸå›åŸ·ï¼ˆè®“å·¥ç¨‹å¸«å¯è§€å¯Ÿæ•´é«”å®‰å…¨å›è·¯ï¼‰
                # ------------------------------------------------------------------
                print(f"âœ… [{time.strftime('%H:%M:%S')}] éƒµç®±å¯«å…¥æˆåŠŸ: {status_file_path}")
                sys.stdout.flush()

                # æ›´æ–°å¿«å– â†’ é¿å…ä¸‹æ¬¡ä¸å¿…è¦çš„å¯«å…¥
                self._last_muted_paths_state = current_muted_paths.copy()

            except IOError as e:
                # DEFENSEï¼šç¢ºä¿éŒ¯èª¤æœƒè¢«çœ‹è¦‹ï¼Œè€Œä¸æ˜¯éœé»˜å¤±æ•—
                print(f"âŒ [{time.strftime('%H:%M:%S')}] å¯«å…¥éƒµç®±å¤±æ•—: {e}", file=sys.stderr)

# ==============================================================================
# mainï¼šå“¨å…µå·¥äººçš„ä¸»å…¥å£ï¼ˆv9.1 - é‡ç”Ÿç‰ˆï¼‰
# ==============================================================================

def main():
    """
    å“¨å…µå­é€²ç¨‹ï¼ˆSentry Workerï¼‰çš„å•Ÿå‹•å…¥å£ã€‚

    WHYï¼ˆç‚ºä»€éº¼éœ€è¦é€™å€‹å…¥å£ï¼Ÿï¼‰
    ----------------------------
    - daemon.py å¿…é ˆèƒ½ä»¥ã€Œå­é€²ç¨‹ã€æ–¹å¼å•Ÿå‹•å“¨å…µã€‚
    - æ¯å€‹å“¨å…µé€²ç¨‹ä»£è¡¨ä¸€å€‹å°ˆæ¡ˆï¼Œä¸¦è² è²¬è©²å°ˆæ¡ˆçš„å¯¦æ™‚æª”æ¡ˆç›£æ§ã€‚
    - å“¨å…µéœ€è¦èƒ½ç¨ç«‹åŸ·è¡Œã€ç¨ç«‹é—œé–‰ã€ç¨ç«‹è‡ªç™’ã€‚
    
    WHATï¼ˆé€™è£¡æœƒåšä»€éº¼ï¼Ÿï¼‰
    ------------------------
    1. è§£æå•Ÿå‹•åƒæ•¸ï¼ˆUUID / å°ˆæ¡ˆè·¯å¾‘ / output_file é»‘åå–®ï¼‰
    2. åˆå§‹åŒ– SmartThrottlerï¼ˆæ™ºèƒ½æŠ‘åˆ¶å™¨ï¼‰
    3. å»ºç«‹ SentryEventHandlerï¼ˆäº‹ä»¶ç®¡ç·šï¼‰
    4. ä½¿ç”¨ PollingObserver å•Ÿå‹•è¼ªè©¢å¼ç›£æ§
    5. é€²å…¥æ°¸çºŒäº‹ä»¶è¿´åœˆï¼Œç›´åˆ°çˆ¶ç¨‹åºè¦æ±‚åœæ­¢

    HOWï¼ˆå®ƒæ˜¯æ€éº¼åšåˆ°çš„ï¼Ÿï¼‰
    --------------------------
    - é€é watchdog çš„ PollingObserver é€²è¡Œè·¨å¹³å°ç›£æ§
    - æ¯ç§’ sleep(1) é¿å…è³‡æºä½”ç”¨
    - æ•æ‰ KeyboardInterruptï¼Œä½†å¯¦éš›ä¸Š SIGINT å·²è¢«å¿½ç•¥
    """

    # ----------------------------------------------------------------------
    # 1. è§£æå‘½ä»¤åˆ—åƒæ•¸ï¼ˆUUIDã€ç›£æ§è·¯å¾‘ã€output_file é»‘åå–®ï¼‰
    # ----------------------------------------------------------------------
    if len(sys.argv) < 3 or len(sys.argv) > 4:
        print("ç”¨æ³•: python sentry_worker.py <project_uuid> <project_path> [output_files]", file=sys.stderr)
        sys.exit(1)

    project_uuid = sys.argv[1]
    project_path_to_watch = sys.argv[2]

    # OUTPUT-FILE-BLACKLIST æ©Ÿåˆ¶ï¼š
    # ä»¥é€—è™Ÿåˆ†éš”çš„å­—ä¸² â†’ é‚„åŸç‚º list â†’ å†è½‰ç‚º set
    output_files_str = sys.argv[3] if len(sys.argv) == 4 else ''
    output_file_paths = [p.strip() for p in output_files_str.split(',') if p.strip()]


    # ----------------------------------------------------------------------
    # 2. é˜²ç¦¦ï¼šæª¢æŸ¥ç›£æ§ç›®éŒ„æ˜¯å¦å­˜åœ¨
    # ----------------------------------------------------------------------
    if not os.path.exists(project_path_to_watch):
        print(f"éŒ¯èª¤: ç›£æ§è·¯å¾‘ '{project_path_to_watch}' ä¸å­˜åœ¨ã€‚", file=sys.stderr)
        sys.exit(1)

    # ----------------------------------------------------------------------
    # 3. å•Ÿå‹•è¨Šæ¯ï¼ˆå¯è§€å¯Ÿæ€§ï¼‰
    # ----------------------------------------------------------------------
    print(f"å“¨å…µå·¥äººå·²å•Ÿå‹•ã€‚PID: {os.getpid()}ã€‚è² è²¬å°ˆæ¡ˆ: {project_uuid}")
    print(f"å°‡ä½¿ç”¨ã€Œå¯é è¼ªè©¢ã€æ¨¡å¼ï¼Œç›£æ§ç›®éŒ„: {project_path_to_watch}")
    sys.stdout.flush()

    # OUTPUT-FILE-BLACKLIST è¨ºæ–·è¨Šæ¯
    if output_file_paths:
        print(f"ã€OUTPUT-FILE-BLACKLISTã€‘å·²åŠ è¼‰ {len(output_file_paths)} å€‹è¼¸å‡ºæ–‡ä»¶åˆ°é»‘åå–®:")
        for path in output_file_paths:
            print(f"  - {path}")
    else:
        print("ã€OUTPUT-FILE-BLACKLISTã€‘æœªæ¥æ”¶åˆ°ä»»ä½•è¼¸å‡ºæ–‡ä»¶é»‘åå–®")
    sys.stdout.flush()


    # ----------------------------------------------------------------------
    # 4. å»ºç«‹æ ¸å¿ƒç‰©ä»¶ï¼ˆSmartThrottler + SentryEventHandlerï¼‰
    # ----------------------------------------------------------------------
    throttler = SmartThrottler()
    event_handler = SentryEventHandler(
        throttler=throttler,
        project_uuid=project_uuid,
        output_file_paths=output_file_paths
    )

    # ----------------------------------------------------------------------
    # 5. å•Ÿå‹•è¼ªè©¢å¼æª”æ¡ˆç›£æ§ï¼ˆPollingObserverï¼‰
    # ----------------------------------------------------------------------
    observer = PollingObserver(timeout=2)  # è¼ªè©¢é€±æœŸï¼š2 ç§’
    observer.schedule(event_handler, project_path_to_watch, recursive=True)
    observer.start()

    # ----------------------------------------------------------------------
    # 6. æ°¸çºŒäº‹ä»¶è¿´åœˆï¼šå“¨å…µçš„ã€Œç”Ÿå‘½é€±æœŸã€
    # ----------------------------------------------------------------------
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        # å¯¦å‹™ä¸Š SIGINT å·²è¢«å¿½ç•¥ï¼Œä½†ä¿ç•™æ­¤æ®µä½œç‚ºå®‰å…¨é–˜
        print("\næ”¶åˆ°é€€å‡ºä¿¡è™Ÿï¼Œæ­£åœ¨åœæ­¢è§€å¯Ÿè€…...")
    finally:
        observer.stop()
        observer.join()
        print("è§€å¯Ÿè€…å·²æˆåŠŸåœæ­¢ã€‚")


# Python æ¨™æº–å…¥å£ï¼šè‹¥æœ¬æª”æ¡ˆè¢«ç›´æ¥åŸ·è¡Œï¼Œå‰‡å•Ÿå‹• main()
if __name__ == "__main__":
    main()
